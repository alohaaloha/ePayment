package travelsafe.business.rules;

import travelsafe.model.*;

declare ElementsOfPrice
    basicPrice : Double
    tiPrice : Double
    hiPrice : Double
    ciPrice : Double
end

/*
// Part for the first solution for sport
declare ItemCounter
    id : Long
    count : Long
    coef : Double
end
*/
###
###

rule "Initialize elements of price"
salience 0
dialect "mvel"
    when
        TravelInsurance()
    then
        ElementsOfPrice elementsOfPrice = new ElementsOfPrice();

        elementsOfPrice.setBasicPrice(0.0);
        elementsOfPrice.setTiPrice(0.0);
        elementsOfPrice.setHiPrice(0.0);
        elementsOfPrice.setCiPrice(0.0);

        insertLogical(elementsOfPrice)
    end

###
###

# INITIAL CALCULATE

rule "Initial/basic price"
salience -1
dialect "mvel"
    when
        $travelInsurance : TravelInsurance()
        $price : Price()
        $elementsOfPrice : ElementsOfPrice()
    then
        Double basicPrice = $price.getAmount();

        $elementsOfPrice.setBasicPrice(basicPrice);
    end

###
###

# TRAVEL INSURANCE

rule "Travel insurance duration - any"
salience -2
dialect "mvel"
    when
        $travelInsurance : TravelInsurance($duration : getDuration(), 0 <= $duration)
        $typeOfRisk : TypeOfRisk(code == "duration_ti")
        $item : Item($itemCoef : coef, code == "any", typeOfRisk.id == $typeOfRisk.id)
        $elementsOfPrice : ElementsOfPrice($tiPrice : tiPrice)
    then
        Double newTiPrice = $duration * $itemCoef;

        $elementsOfPrice.setTiPrice(newTiPrice);
    end

###

rule "Travel insurance region - selectd exist"
salience -3
dialect "mvel"
    when
        $travelInsurance : TravelInsurance($region : region, region != null)
        $typeOfRisk : TypeOfRisk(code == "region_ti")
        $item : Item($itemCoef : coef, typeOfRisk.id == $typeOfRisk.id, id == $travelInsurance.region.id)
        $elementsOfPrice : ElementsOfPrice($tiPrice : tiPrice)
    then
        Double newTiPrice = $tiPrice * $itemCoef;

        $elementsOfPrice.setTiPrice(newTiPrice);
    end

###

rule "Travel insurance number of people - le_5"
salience -4
dialect "mvel"
    when
        $travelInsurance : TravelInsurance($numberOfPeople : numberOfPeople, 0 <= numberOfPeople, numberOfPeople <= 5)
        $typeOfRisk : TypeOfRisk(code == "number_of_people_ti")
        $item : Item($itemCoef : coef, code == "le_5", typeOfRisk.id == $typeOfRisk.id)
        $elementsOfPrice : ElementsOfPrice($tiPrice : tiPrice)
    then
        Double newTiPrice = $tiPrice * $numberOfPeople * $itemCoef;

        $elementsOfPrice.setTiPrice(newTiPrice);
    end

rule "Travel insurance number of people - gt_5"
salience -4
dialect "mvel"
    when
        $travelInsurance : TravelInsurance($numberOfPeople : numberOfPeople, numberOfPeople > 5)
        $typeOfRisk : TypeOfRisk(code == "number_of_people_ti")
        $item : Item($itemCoef : coef, code == "gt_5", typeOfRisk.id == $typeOfRisk.id)
        $elementsOfPrice : ElementsOfPrice($tiPrice : tiPrice)
    then
        Double newTiPrice = $tiPrice * $numberOfPeople * $itemCoef;

        $elementsOfPrice.setTiPrice(newTiPrice);
    end

###

###

/*
// The first solution for sport
rule "Travel insurance sport - first count"
salience -6
dialect "mvel"
    when
        $travelInsurance : TravelInsurance()
        $typeOfRisk : TypeOfRisk(code == "sport_ti")
        $item : Item($itemCoef : coef, $itemId : id, typeOfRisk.id == $typeOfRisk.id)
        not ItemCounter(id == $itemId)
    then
        ItemCounter itemCounter = new ItemCounter();
        itemCounter.setId($itemId);
        itemCounter.setCount(new Long(1));
        itemCounter.setCoef($itemCoef);

        insert(itemCounter);

        System.out.println($itemId);
    end

rule "Travel insurance sport - count"
salience -7
dialect "mvel"
    when
        $travelInsurance : TravelInsurance()
        $participantInInsurance : ParticipantInInsurance($participantsItems : items, items != null)
        $typeOfRisk : TypeOfRisk(code == "sport_ti")
        $item : Item($itemId : id, typeOfRisk.id == $typeOfRisk.id)
        Item(id == $itemId) from $participantsItems
        $itemCounter : ItemCounter(id == $itemId, $count : count)
    then
        $itemCounter.setCount($count + new Long(1));

        System.out.println($itemId + " " + $itemCounter.getCount());
    end

rule "Travel insurance sport - calculate"
salience -8
dialect "mvel"
    when
        $travelInsurance : TravelInsurance()
        $itemCounter : ItemCounter(count > 0)
        $elementsOfPrice : ElementsOfPrice($tiPrice : tiPrice)
    then
        System.out.println("c: " + $itemCounter.getId() + " " + $itemCounter.getCount());
        Double newTiPrice = $tiPrice * $itemCounter.getCount() * $itemCounter.getCoef();

        $elementsOfPrice.setTiPrice(newTiPrice);
    end
*/

// The second solution for sport
rule "Travel insurance sport - count"
salience -8
dialect "mvel"
    when
        $travelInsurance : TravelInsurance()
        $participantInInsurance : ParticipantInInsurance($participantsItems : items, items != null)
        $typeOfRisk : TypeOfRisk(code == "sport_ti")
        $item : Item($itemId : id, $itemCoef : coef, typeOfRisk.id == $typeOfRisk.id)
        Item(id == $itemId) from $participantsItems
        $elementsOfPrice : ElementsOfPrice($tiPrice : tiPrice)
    then
        Double newTiPrice = $tiPrice * $itemCoef;

        $elementsOfPrice.setTiPrice(newTiPrice);
    end

###

rule "Travel insurance max amount - 1000 USD"
salience -9
dialect "mvel"
    when
        $travelInsurance : TravelInsurance(maxAmount == 1000)
        $typeOfRisk : TypeOfRisk(code == "max_amount_ti")
        $item : Item($itemCoef : coef, code == "1000usd", typeOfRisk.id == $typeOfRisk.id)
        $elementsOfPrice : ElementsOfPrice($tiPrice : tiPrice)
    then
        Double newTiPrice = $tiPrice * $itemCoef;

        $elementsOfPrice.setTiPrice(newTiPrice);
    end

rule "Travel insurance max amount - 5000 USD"
salience -9
dialect "mvel"
    when
        $travelInsurance : TravelInsurance(maxAmount == 5000)
        $typeOfRisk : TypeOfRisk(code == "max_amount_ti")
        $item : Item($itemCoef : coef, code == "5000usd", typeOfRisk.id == $typeOfRisk.id)
        $elementsOfPrice : ElementsOfPrice($tiPrice : tiPrice)
    then
        Double newTiPrice = $tiPrice * $itemCoef;

        $elementsOfPrice.setTiPrice(newTiPrice);
    end

rule "Travel insurance max amount - 10000 USD"
salience -9
dialect "mvel"
    when
        $travelInsurance : TravelInsurance(maxAmount == 10000)
        $typeOfRisk : TypeOfRisk(code == "max_amount_ti")
        $item : Item($itemCoef : coef, code == "10000usd", typeOfRisk.id == $typeOfRisk.id)
        $elementsOfPrice : ElementsOfPrice($tiPrice : tiPrice)
    then
        Double newTiPrice = $tiPrice * $itemCoef;

        $elementsOfPrice.setTiPrice(newTiPrice);
    end

rule "Travel insurance max amount - 30000 USD"
salience -9
dialect "mvel"
    when
        $travelInsurance : TravelInsurance(maxAmount == 30000)
        $typeOfRisk : TypeOfRisk(code == "max_amount_ti")
        $item : Item($itemCoef : coef, code == "30000usd", typeOfRisk.id == $typeOfRisk.id)
        $elementsOfPrice : ElementsOfPrice($tiPrice : tiPrice)
    then
        Double newTiPrice = $tiPrice * $itemCoef;

        $elementsOfPrice.setTiPrice(newTiPrice);
    end

###
###

# HOME INSURANCE

rule "Home insurance duration - any"
salience -10
dialect "mvel"
    when
        $travelInsurance : TravelInsurance()
        $homeInsurance : HomeInsurance($duration : getDuration(), 0 <= $duration)
        $typeOfRisk : TypeOfRisk(code == "duration_hi")
        $item : Item($itemCoef : coef, code == "any", typeOfRisk.id == $typeOfRisk.id)
        $elementsOfPrice : ElementsOfPrice($hiPrice : hiPrice)
    then
        Double newHiPrice = $duration * $itemCoef;

        $elementsOfPrice.setHiPrice(newHiPrice);
    end

###

rule "Home insurance surface area - less than or equal to 50m^2"
salience -11
dialect "mvel"
    when
        $travelInsurance : TravelInsurance()
        $homeInsurance : HomeInsurance($surfaceArea : surfaceArea, 0 <= surfaceArea, surfaceArea <= 50)
        $typeOfRisk : TypeOfRisk(code == "surface_area_hi")
        $item : Item($itemCoef : coef, code == "le_50m2", typeOfRisk.id == $typeOfRisk.id)
        $elementsOfPrice : ElementsOfPrice($hiPrice : hiPrice)
    then
        Double newHiPrice = $hiPrice * $surfaceArea * $itemCoef;

        $elementsOfPrice.setHiPrice(newHiPrice);
    end

rule "Home insurance surface area - more than 50m^2"
salience -11
dialect "mvel"
    when
        $travelInsurance : TravelInsurance()
        $homeInsurance : HomeInsurance($surfaceArea : surfaceArea, surfaceArea > 50)
        $typeOfRisk : TypeOfRisk(code == "surface_area_hi")
        $item : Item($itemCoef : coef, code == "gt_50m2", typeOfRisk.id == $typeOfRisk.id)
        $elementsOfPrice : ElementsOfPrice($hiPrice : hiPrice)
    then
        Double newHiPrice = $hiPrice * $surfaceArea * $itemCoef;

        $elementsOfPrice.setHiPrice(newHiPrice);
    end

###

rule "Home insurance age - less than or equal to 10 years"
salience -12
dialect "mvel"
    when
        $travelInsurance : TravelInsurance()
        $homeInsurance : HomeInsurance(0 <= age, age <= 10)
        $typeOfRisk : TypeOfRisk(code == "age_hi")
        $item : Item($itemCoef : coef, code == "le_10", typeOfRisk.id == $typeOfRisk.id)
        $elementsOfPrice : ElementsOfPrice($hiPrice : hiPrice)
    then
        Double newHiPrice = $hiPrice * $itemCoef;

        $elementsOfPrice.setHiPrice(newHiPrice);
    end

rule "Home insurance age - more than 10 years"
salience -12
dialect "mvel"
    when
        $travelInsurance : TravelInsurance()
        $homeInsurance : HomeInsurance(age > 10)
        $typeOfRisk : TypeOfRisk(code == "age_hi")
        $item : Item($itemCoef : coef, code == "gt_10", typeOfRisk.id == $typeOfRisk.id)
        $elementsOfPrice : ElementsOfPrice($hiPrice : hiPrice)
    then
        Double newHiPrice = $hiPrice * $itemCoef;

        $elementsOfPrice.setHiPrice(newHiPrice);
    end

###

rule "Home insurance estimated value - all"
salience -13
dialect "mvel"
    when
        $travelInsurance : TravelInsurance()
        $homeInsurance : HomeInsurance($estimatedValue : estimatedValue)
        $typeOfRisk : TypeOfRisk(code == "estimated_value_hi")
        $item : Item($itemCoef : coef, code == "all", typeOfRisk.id == $typeOfRisk.id)
        $elementsOfPrice : ElementsOfPrice($hiPrice : hiPrice)
    then
        Double newHiPrice = $hiPrice * $estimatedValue * $item.getCoef();

        $elementsOfPrice.setHiPrice(newHiPrice);
    end

###

rule "Home insurance insurance descriptions"
salience -14
dialect "mvel"
    when
        $travelInsurance : TravelInsurance()
        $homeInsurance : HomeInsurance($insuranceDescriptions : insuranceDescriptions, insuranceDescriptions != null)
        $typeOfRisk : TypeOfRisk(code == "insurance_desc_hi")
        $item : Item($itemId : id, $itemCoef : coef, typeOfRisk.id == $typeOfRisk.id)
        Item(id == $itemId) from $insuranceDescriptions
        $elementsOfPrice : ElementsOfPrice($hiPrice : hiPrice)
    then
        Double newHiPrice = $hiPrice * $itemCoef;

        $elementsOfPrice.setHiPrice(newHiPrice);
    end

###
###

# CAR INSURANCE

rule "Car insurance duration - any"
salience -15
dialect "mvel"
    when
        $travelInsurance : TravelInsurance()
        $carInsurance : CarInsurance($duration : getDuration(), 0 <= $duration)
        $typeOfRisk : TypeOfRisk(code == "duration_ci")
        $item : Item($itemCoef : coef, code == "any", typeOfRisk.id == $typeOfRisk.id)
        $elementsOfPrice : ElementsOfPrice($ciPrice : ciPrice)
    then
        Double newCiPrice = $itemCoef * $duration;

        $elementsOfPrice.setCiPrice(newCiPrice);
    end

###

rule "Car insurance car packages"
salience -16
dialect "mvel"
    when
        $travelInsurance : TravelInsurance()
        $carInsurance : CarInsurance($carPackagesItems : carPackagesItems, carPackagesItems != null)
        $typeOfRisk : TypeOfRisk(code == "car_package_ci")
        $item : Item($itemId : id, $itemCoef : coef, typeOfRisk.id == $typeOfRisk.id)
        Item(id == $itemId) from $carPackagesItems
        $elementsOfPrice : ElementsOfPrice($ciPrice : ciPrice)
    then
        Double newCiPrice = $ciPrice * $itemCoef;

        $elementsOfPrice.setCiPrice(newCiPrice);
    end

###
###

# FINAL CALCULATE

rule "Calculate total price"
salience -50
dialect "mvel"
    when
        $travelInsurance : TravelInsurance()
        $elementsOfPrice : ElementsOfPrice()
    then
        Double basicPrice = $elementsOfPrice.getBasicPrice();
        Double tiPrice = $elementsOfPrice.getTiPrice();
        Double hiPrice = $elementsOfPrice.getHiPrice();
        Double ciPrice = $elementsOfPrice.getCiPrice();
        Double newTotalPrice = basicPrice + tiPrice + hiPrice + ciPrice;

        $travelInsurance.setTotalPrice(newTotalPrice);
    end
